import psycopg2
import csv

# Подключение к базе
connection = psycopg2.connect(
    host='localhost',
    database='phonebook',
    user='postgres',
    password='678910'
)
connection.autocommit = True
curs = connection.cursor()

# Вставка или обновление одного пользователя
def inputData():
    fname = input("Firstname: ").strip()
    lname = input("Lastname: ").strip()
    phone = input("Phone number: ").strip()

    curs.execute("SELECT id FROM users WHERE firstname=%s AND lastname=%s", (fname, lname))
    row = curs.fetchone()
    if row:
        curs.execute("UPDATE users SET phone=%s WHERE id=%s", (phone, row[0]))
        print("User updated successfully.\n")
    else:
        curs.execute("INSERT INTO users (firstname, lastname, phone) VALUES (%s, %s, %s)", (fname, lname, phone))
        print("User inserted successfully.\n")

# Импорт пользователей из CSV
def importFromCSV():
    path = input("Enter CSV path: ").strip()
    incorrect = []

    with open(path, 'r') as file:
        reader = csv.reader(file)
        for row in reader:
            if len(row) != 3:
                incorrect.append(row)
                continue
            fname, lname, phone = row
            if not phone.isdigit():
                incorrect.append(row)
                continue
            curs.execute("SELECT id FROM users WHERE firstname=%s AND lastname=%s", (fname, lname))
            existing = curs.fetchone()
            if existing:
                curs.execute("UPDATE users SET phone=%s WHERE id=%s", (phone, existing[0]))
            else:
                curs.execute("INSERT INTO users (firstname, lastname, phone) VALUES (%s, %s, %s)", (fname, lname, phone))

    if incorrect:
        print("Incorrect rows skipped:", incorrect)
    else:
        print("All users imported successfully.\n")

# Пагинация пользователей
def update_contact():
    try:
        limit = int(input("Limit: "))
        offset = int(input("Offset: "))
    except ValueError:
        print("Invalid input.\n")
        return

    curs.execute("SELECT * FROM users LIMIT %s OFFSET %s", (limit, offset))
    rows = curs.fetchall()

    if not rows:
        print("No records found.\n")
        return

    print("\n--- Records ---")
    for r in rows:
        print(r)
    print()

# Поиск по шаблону
def queryData():
    pattern = input("Enter pattern to search: ").strip()
    search_pattern = f"%{pattern}%"

    curs.execute(
        "SELECT * FROM users WHERE firstname LIKE %s OR lastname LIKE %s OR phone LIKE %s",
        (search_pattern, search_pattern, search_pattern)
    )
    rows = curs.fetchall()

    if not rows:
        print("No matching records found.\n")
        return

    print("\n--- Found Records ---")
    for r in rows:
        print(r)

    with open("queriedData.txt", "w") as file:
        for r in rows:
            file.write(str(r) + "\n")
    print("Saved to queriedData.txt\n")

# Удаление по имени/фамилии и/или телефону
def deleteData():
    name_or_lname = input("Enter name or lastname: ").strip()
    phone = input("Enter phone (optional): ").strip() or None

    if phone:
        curs.execute(
            "DELETE FROM users WHERE (firstname=%s OR lastname=%s) AND phone=%s",
            (name_or_lname, name_or_lname, phone)
        )
    else:
        curs.execute(
            "DELETE FROM users WHERE firstname=%s OR lastname=%s",
            (name_or_lname, name_or_lname)
        )
    print("Deleted.\n")

# Удаление всех данных
def deleteAllData():
    sure = input("Are you sure? (1 = yes): ").strip()
    if sure == "1":
        curs.execute("DELETE FROM users")
        print("All data deleted.\n")
    else:
        print("Cancelled.\n")

# Главное меню
while True:
    print("""
What do you want to do?
[1] Input data from console
[2] Upload from CSV
[3] Users by limit and offset
[4] Query data
[5] Delete by name or phone
[6] Delete all data
[7] Exit
""")
    choice = input("Enter number: ").strip()

    if choice == "1":
        inputData()
    elif choice == "2":
        importFromCSV()
    elif choice == "3":
        update_contact()
    elif choice == "4":
        queryData()
    elif choice == "5":
        deleteData()
    elif choice == "6":
        deleteAllData()
    elif choice == "7":
        print("Goodbye.")
        break
    else:
        print("Invalid choice. Try again.\n")

curs.close()
connection.close()
